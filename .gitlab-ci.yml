stages:
  - build-website
  - deploy-website

.assume_role: &assume_role
    - >
      STS=($(aws sts assume-role-with-web-identity
      --role-arn ${ROLE_ARN}
      --role-session-name "GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}"
      --web-identity-token $ID_TOKEN
      --duration-seconds 3600
      --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]'
      --output text))s
    - export AWS_ACCESS_KEY_ID="${STS[0]}"
    - export AWS_SECRET_ACCESS_KEY="${STS[1]}"
    - export AWS_SESSION_TOKEN="${STS[2]}"

build website:
  stage: build-website
  image: node:latest
  script:
    - cd website/dripdrop  # Navigate to the directory where package.json is
    - npm install
    - npm run build
  artifacts:
    paths:
      - website/dripdrop/build/ 
    when: always
  # rules:
  #   - if: '$CI_COMMIT_REF_NAME == "master"'
  #     changes:
  #       - website/dripdrop/**/*

deploy website:
  stage: deploy-website
  image:
    name: amazon/aws-cli:latest
    entrypoint:
      - '/usr/bin/env'
  id_tokens:
      ID_TOKEN:
        aud: sdmay25-25-s3-deploy
  extends: assume_role
  before_script:
    - npm install -g aws-cdk@latest
    - cdk --version
  script:
    - cd aws/ 
    - echo "Compiling the code..."
    - npm install
    - npm run build
    - echo "Compile complete."
    - npx cdk synth
    - cdk diff
    - cdk deploy WebsiteHostingStack --require-approval never
  # rules:
  #   - if: '$CI_COMMIT_REF_NAME == "master"'
  #     changes:
  #       - website/dripdrop/**/*



